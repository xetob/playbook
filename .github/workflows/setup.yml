jobs:
  Build_GSI:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Clone FoxetGSI-tool with submodules
        run: |
          git clone --recurse-submodules https://github.com/FoxetGSI/FoxetGSI-tool.git
          cd FoxetGSI-tool

      - name: Install packages
        run: |
          cd FoxetGSI-tool
          sudo bash setup.sh

      - name: Build GSI
        env:
          ROM_TYPE: ${{ github.event.inputs.rom_type }}
          ROM_LINK: ${{ github.event.inputs.rom_link }}
          ROM_TYPE_OPTION: ${{ github.event.inputs.rom_type_option }}
        run: |
          cd FoxetGSI-tool
          if [ "$ROM_TYPE_OPTION" == "AB" ]; then
            sudo bash url2GSI.sh $ROM_LINK $ROM_TYPE --ab
          else
            sudo bash url2GSI.sh $ROM_LINK $ROM_TYPE --aonly
          fi

      - name: Package .img file into .tar.xz
        run: |
          cd FoxetGSI-tool/output/
          # Find the .img file (assuming there is only one)
          IMG_FILE=$(ls *.img)
          
          # Create a tar.xz archive with the same name (without .img extension)
          tar -cJf "${IMG_FILE%.img}.tar.xz" "$IMG_FILE"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: FoxetGSI-tool/output/*.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
